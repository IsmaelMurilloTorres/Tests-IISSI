<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autoescuela ISSI</title>
    <style>
        :root { --primary:#2563eb; --danger:#dc2626; --success:#16a34a; --warning:#f59e0b; --bg:#f3f4f6; --text:#1f2937; }
        body { font-family:system-ui,-apple-system,sans-serif; background:var(--bg); color:var(--text); margin:0; display:flex; flex-direction:column; min-height:100vh; }
        .screen { display:none; padding:20px; max-width:800px; margin:0 auto; width:100%; box-sizing:border-box; }
        .screen.active { display:block; }
        .hero { text-align:center; padding:40px 20px; }
        h1 { color:var(--primary); margin-bottom:10px; }
        .grid-temas { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:15px; margin-bottom:30px; }
        .btn { background:#fff; border:2px solid var(--primary); color:var(--primary); padding:15px; border-radius:12px; font-weight:600; cursor:pointer; text-align:center; transition:0.2s; }
        .btn:hover { background:var(--primary); color:#fff; transform:translateY(-2px); }
        .btn-large { width:100%; background:var(--primary); color:#fff; font-size:1.2rem; padding:20px; margin-bottom:15px; }
        .btn-home { background:#e5e7eb; border:none; padding:5px 10px; border-radius:6px; cursor:pointer; font-size:0.9rem; color:#374151; }
        .btn-terminate { width:100%; background:var(--warning); color:#fff; border:none; padding:12px; border-radius:12px; font-weight:bold; margin-top:15px; cursor:pointer; font-size:1rem; }
        .btn-terminate:hover { background:#d97706; }
        .topic-selector { background:#fff; padding:15px; border-radius:8px; display:grid; grid-template-columns:repeat(auto-fill,minmax(100px,1fr)); gap:10px; margin-bottom:20px; }
        .topic-check label { display:flex; align-items:center; gap:8px; cursor:pointer; font-size:0.9rem; }
        .test-header { display:flex; justify-content:space-between; align-items:center; background:#fff; padding:15px; border-radius:12px; margin-bottom:20px; position:sticky; top:10px; z-index:10; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
        .progress-bar { height:6px; background:#e5e7eb; border-radius:3px; margin-bottom:20px; overflow:hidden; }
        .progress-fill { height:100%; background:var(--primary); width:0%; transition:width 0.3s; }
        .question-card { background:#fff; padding:25px; border-radius:16px; margin-bottom:20px; box-shadow:0 4px 6px rgba(0,0,0,0.05); }
        .question-text { font-size:1.1rem; font-weight:600; margin-bottom:20px; line-height:1.5; }
        .multi-tag { font-size:0.8rem; background:#eff6ff; color:var(--primary); padding:4px 8px; border-radius:4px; margin-left:10px; border:1px solid #bfdbfe; display:inline-block; }
        .options-grid { display:flex; flex-direction:column; gap:10px; }
        .option-btn { padding:15px; border:2px solid #e5e7eb; background:#fff; border-radius:8px; cursor:pointer; display:flex; gap:10px; transition:0.2s; }
        .option-btn:hover { border-color:var(--primary); background:#f8fafc; }
        .option-btn.selected { border-color:var(--primary); background:#eff6ff; font-weight:600; }
        .opt-letter { font-weight:bold; color:#6b7280; min-width:25px; }
        .nav-buttons { display:flex; justify-content:space-between; gap:10px; }
        .score-card { background:#fff; padding:40px; border-radius:20px; text-align:center; box-shadow:0 10px 25px rgba(0,0,0,0.1); }
        .score-number { font-size:4rem; font-weight:800; color:var(--primary); margin:10px 0; }
        .result-badge { display:inline-block; padding:8px 20px; border-radius:50px; font-weight:bold; font-size:1.2rem; margin-bottom:20px; }
        .apto { background:#dcfce7; color:var(--success); }
        .no-apto { background:#fee2e2; color:var(--danger); }
        .stats-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:15px; margin-top:30px; }
        .stat-box { background:#f9fafb; padding:15px; border-radius:10px; }
        .stat-val { font-size:1.5rem; font-weight:bold; }
    </style>
</head>
<body>

<div id="home-screen" class="screen active">
    <div class="hero">
        <h1>游꿉 Autoescuela ISSI</h1>
        <p>Ingenier칤a del Software</p>
    </div>
    <button class="btn btn-large" onclick="iniciarTestGlobal()">游 SIMULACRO GLOBAL (20 Preguntas)</button>
    <h2>Practicar por Temas</h2>
    <div class="grid-temas" id="grid-temas">Cargando...</div>
    <h2>Test Personalizado</h2>
    <div class="topic-selector" id="multi-selector">Cargando...</div>
    <button class="btn" style="width:100%" onclick="iniciarTestMulti()">Comenzar Personalizado</button>
</div>

<div id="test-screen" class="screen">
    <div class="test-header">
        <button class="btn-home" onclick="irInicio()">游 Men칰</button>
        <div><span id="current-q">1</span>/<span id="total-q">20</span></div>
        <div id="timer" style="color:var(--danger);font-weight:bold">30:00</div>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
    
    <div class="question-card">
        <div class="question-text" id="question-text"></div>
        <div class="options-grid" id="options-container"></div>
    </div>
    
    <div class="nav-buttons">
        <button class="btn" id="btn-prev" onclick="navPregunta(-1)" style="display:none">Anterior</button>
        <div style="flex:1"></div>
        <button class="btn" id="btn-next" onclick="navPregunta(1)">Siguiente</button>
    </div>
    <button class="btn-terminate" onclick="if(confirm('쯉eguro que quieres terminar ya?')) finalizarTest()">游끠 Corregir Test Ahora</button>
</div>

<div id="result-screen" class="screen">
    <div class="score-card">
        <h2>Resultado</h2>
        <div id="result-badge" class="result-badge">---</div>
        <div>Nota final:</div>
        <div class="score-number" id="final-score">0.0</div>
        <div class="stats-grid">
            <div class="stat-box"><div class="stat-val" id="stat-ok" style="color:var(--success)">0</div><div>Aciertos</div></div>
            <div class="stat-box"><div class="stat-val" id="stat-fail" style="color:var(--danger)">0</div><div>Fallos</div></div>
            <div class="stat-box"><div class="stat-val" id="stat-blank">0</div><div>Blanco</div></div>
        </div>
        <button class="btn btn-large" style="margin-top:30px;" onclick="irInicio()">Volver al Inicio</button>
    </div>
</div>

<script src="preguntas.js"></script>

<script>
// DETECTOR DE ERRORES: Si preguntas.js falla, avisa.
window.onerror = function(msg, url, line) {
   // Si el error es "DB is not defined", es porque fall칩 la carga de preguntas.js
   if(msg.includes("DB is not defined")) {
       document.getElementById('grid-temas').innerHTML = "<p style='color:red; font-weight:bold'>ERROR CR칈TICO: No se ha podido cargar el archivo 'preguntas.js'.<br>Aseg칰rate de que est치 subido en la misma carpeta y no tiene errores de sintaxis.</p>";
   }
};

let preguntasActuales=[], respuestasUsuario={}, indiceActual=0, timerInterval, segundosRestantes=1800, modoExamen=false;

const temasContainer = document.getElementById('grid-temas');
const multiContainer = document.getElementById('multi-selector');

function initApp() {
    temasContainer.innerHTML = ''; multiContainer.innerHTML = '';
    
    // Verificaci칩n de seguridad
    if (typeof DB === 'undefined') {
        // El onerror saltar치, pero por si acaso:
        console.error("DB no est치 definida. Revisa preguntas.js");
        return;
    }

    const temasDisponibles = [...new Set(DB.map(i => i.t))].sort((a,b) => a-b);

    if(temasDisponibles.length===0){
        temasContainer.innerHTML="<p>No hay preguntas cargadas.</p>";
    } else {
        temasDisponibles.forEach(t => {
            let btn=document.createElement('div'); btn.className='btn'; btn.innerHTML=`<span>Tema ${t}</span>`;
            btn.onclick=()=>iniciarTestTema(t); temasContainer.appendChild(btn);
            let label=document.createElement('label'); label.className='topic-check';
            label.innerHTML=`<input type="checkbox" value="${t}" checked> Tema ${t}`; multiContainer.appendChild(label);
        });
    }
}

function shuffle(array){ return array.sort(()=>Math.random()-0.5); }
function getPreguntas(filtroFn, cant=20){
    let pool=DB.filter(filtroFn);
    if(pool.length<cant) return shuffle(pool).map((p,i)=>({...p, uid:i}));
    return shuffle(pool).slice(0,cant).map((p,i)=>({...p, uid:i}));
}

function iniciarTestGlobal(){ preguntasActuales=getPreguntas(p=>true,20); configurarTest(true); }
function iniciarTestTema(t){ preguntasActuales=getPreguntas(p=>p.t===t,50); configurarTest(false); }
function iniciarTestMulti(){
    const checks=document.querySelectorAll('#multi-selector input:checked');
    const ids=Array.from(checks).map(c=>parseInt(c.value));
    if(ids.length===0) return alert("Selecciona tema");
    preguntasActuales=getPreguntas(p=>ids.includes(p.t),20); configurarTest(true);
}

function configurarTest(esExamen){
    if(preguntasActuales.length===0) return alert("Sin preguntas.");
    modoExamen=esExamen; respuestasUsuario={}; indiceActual=0; segundosRestantes=1800;
    document.getElementById('home-screen').classList.remove('active');
    document.getElementById('result-screen').classList.remove('active');
    document.getElementById('test-screen').classList.add('active');
    document.getElementById('btn-prev').style.display='block';
    document.getElementById('btn-next').style.display='block';
    document.getElementById('total-q').innerText=preguntasActuales.length;
    document.getElementById('timer').style.display = esExamen ? 'block' : 'none';
    if(esExamen) startTimer();
    renderPregunta();
}

function startTimer(){
    clearInterval(timerInterval);
    timerInterval=setInterval(()=>{
        segundosRestantes--;
        let min=Math.floor(segundosRestantes/60), sec=segundosRestantes%60;
        document.getElementById('timer').innerText=`${min}:${sec<10?'0'+sec:sec}`;
        if(segundosRestantes<=0) finalizarTest();
    },1000);
}

function renderPregunta(){
    const p=preguntasActuales[indiceActual];
    const esMulti=Array.isArray(p.c);
    document.getElementById('current-q').innerText=indiceActual+1;
    let html=p.q + (esMulti ? `<span class="multi-tag">Selecci칩n M칰ltiple</span>` : "");
    document.getElementById('question-text').innerHTML=html;
    document.getElementById('progress').style.width=`${((indiceActual)/preguntasActuales.length)*100}%`;
    const cont=document.getElementById('options-container'); cont.innerHTML='';
    const letras=['A','B','C','D','E','F'];
    if(!respuestasUsuario[p.uid]) respuestasUsuario[p.uid]=[];
    p.o.forEach((op,idx)=>{
        const btn=document.createElement('div'); btn.className='option-btn';
        btn.innerHTML=`<span class="opt-letter">${letras[idx]})</span><span>${op}</span>`;
        if(respuestasUsuario[p.uid].includes(idx)) btn.classList.add('selected');
        if(!modoExamen && !esMulti && respuestasUsuario[p.uid].length>0){
            if(idx===p.c) { btn.style.borderColor='var(--success)'; btn.style.background='#dcfce7'; }
            else if(respuestasUsuario[p.uid].includes(idx)) { btn.style.borderColor='var(--danger)'; btn.style.background='#fee2e2'; }
        }
        btn.onclick=()=>seleccionarOpcion(idx,esMulti); cont.appendChild(btn);
    });
    
    // Gesti칩n visual de botones
    if(indiceActual===preguntasActuales.length-1){
        document.getElementById('btn-next').style.display='none';
    } else {
        document.getElementById('btn-next').style.display='block';
    }
}

function seleccionarOpcion(idx,esMulti){
    const p=preguntasActuales[indiceActual];
    let sel=respuestasUsuario[p.uid];
    if(!modoExamen && !esMulti && sel.length>0) return;
    if(esMulti){
        if(sel.includes(idx)) sel=sel.filter(i=>i!==idx); else sel.push(idx);
    } else { sel=[idx]; }
    respuestasUsuario[p.uid]=sel; renderPregunta();
}

function navPregunta(dir){
    if(indiceActual+dir>=0 && indiceActual+dir<preguntasActuales.length){
        indiceActual+=dir; renderPregunta();
    }
}

function arraysIguales(a,b){
    if(a.length!==b.length) return false;
    let s1=[...a].sort(), s2=[...b].sort();
    for(let i=0;i<s1.length;i++) if(s1[i]!==s2[i]) return false;
    return true;
}

function finalizarTest(){
    clearInterval(timerInterval);
    let aciertos=0, fallos=0, blancos=0;
    preguntasActuales.forEach(p=>{
        let u=respuestasUsuario[p.uid]||[];
        if(u.length===0) blancos++;
        else {
            let ok = Array.isArray(p.c) ? arraysIguales(u,p.c) : (u[0]===p.c);
            if(ok) aciertos++; else fallos++;
        }
    });
    let pts=(aciertos*0.5)-(fallos*0.4); if(pts<0) pts=0;
    let max=preguntasActuales.length*0.5;
    let nota=(pts*10)/max; if(nota<0) nota=0; if(nota>10) nota=10;
    
    document.getElementById('test-screen').classList.remove('active');
    document.getElementById('result-screen').classList.add('active');
    document.getElementById('final-score').innerText=nota.toFixed(2);
    document.getElementById('stat-ok').innerText=aciertos;
    document.getElementById('stat-fail').innerText=fallos;
    document.getElementById('stat-blank').innerText=blancos;
    const b=document.getElementById('result-badge');
    if(nota>=5){ b.innerText="APTO"; b.className="result-badge apto"; }
    else { b.innerText="NO APTO"; b.className="result-badge no-apto"; }
}

function irInicio(){
    document.getElementById('result-screen').classList.remove('active');
    document.getElementById('home-screen').classList.add('active');
    initApp(); // Recargar men칰 por si acaso
}

// Arrancar App al cargar la p치gina
window.onload = initApp;
</script>
</body>
</html>
